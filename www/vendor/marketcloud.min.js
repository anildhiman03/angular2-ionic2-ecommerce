/*

*	Marketcloud Javascript SDK
*   https://www.marketcloud.it
*
*	Copyright (c) 2016 Herapi SRLS
*
*	Written by Mattia Alfieri <m.alfieri@marketcloud.it>
*

*/
(function(){function k(){!0===window.DEBUG&&console.log(Array.prototype.slice.call(arguments))}function n(a,b,d){var c="",e;for(e in a)d&&b[d]&&0!==b[d].indexOf(a[e])&&(c+=d),c=b[e]?c+e:c+("["+e+"]"),a[e]instanceof Array?c+=n(a[e],b,e):a[e]instanceof Object?c+=n(a[e],b):(c+="="+a[e],c+="&");return c}function r(){try{return new XMLHttpRequest}catch(a){}try{return new ActiveXObject("Msxml3.XMLHTTP")}catch(a){}try{return new ActiveXObject("Msxml2.XMLHTTP.6.0")}catch(a){}try{return new ActiveXObject("Msxml2.XMLHTTP.3.0")}catch(a){}try{return new ActiveXObject("Msxml2.XMLHTTP")}catch(a){}try{return new ActiveXObject("Microsoft.XMLHTTP")}catch(a){}return null}
var t={data:{},set:function(a,b){this.data[a]=b},get:function(a){return this.data[a]},del:function(a){delete this.data[a]}},u={set:function(a,b){window.localStorage.setItem(a,JSON.stringify(b))},get:function(a){return(a=window.localStorage.getItem(a))?JSON.parse(a):a},del:function(a){window.localStorage.removeItem(a)}},v={set:function(a,b){var d=new Date;d.setTime(d.getTime()+31536E6);d="; expires="+d.toGMTString();document.cookie=a+"="+b+d+"; path=/"},get:function(a){a+="=";for(var b=document.cookie.split(";"),
d=0,c=b.length;d<c;d++){for(var e=b[d];" "===e.charAt(0);)e=e.substring(1,e.length);if(0===e.indexOf(a))return e.substring(a.length,e.length)}return null},del:function(a){this.set(a,"")}},l=function(){var a;try{a="localStorage"in window&&null!==window.localStorage}catch(d){a=!1}if(a)this.storage=u;else{var b;try{b=!0===navigator.cookieEnabled}catch(d){b=!1}b?this.storage=v:(console.hasOwnProperty("warn")?console.warn("This browser does not support  either LocalStorage or Cookies. Falling back to an in-memory store."):
console.log("This browser does not support  either LocalStorage or Cookies. Falling back to an in-memory store."),this.storage=t)}};l.prototype.get=function(a){return this.storage.get(a)};l.prototype.set=function(a,b){return this.storage.set(a,b)};l.prototype.del=function(a){return this.storage.del(a)};var h=function(a){var b=new r;b.open(a.method,a.url,!0);b.onreadystatechange=function(){if(4===b.readyState)if(3<Number(b.status.toString()[0])){if(a.hasOwnProperty("error")){if("function"!==typeof a.error)throw Error("error must be function");
k(JSON.parse(b.responseText));a.error(JSON.parse(b.responseText),b.status)}}else if(a.hasOwnProperty("success")){if("function"!==typeof a.success)throw Error("success must be function");k(JSON.parse(b.responseText));a.success(JSON.parse(b.responseText),b.status)}};b.setRequestHeader("Content-Type","application/json");if(a.hasOwnProperty("headers"))for(var d in a.headers)b.setRequestHeader(d,a.headers[d]);k("Firing "+a.method+" "+a.url,a);a.hasOwnProperty("data")?b.send(JSON.stringify(a.data)):b.send()},
e=function(a,b,d,g){d={success:d,error:g,headers:{}};d.headers.Authorization=c.token?c["public"]+":"+c.token:c["public"];0>a.indexOf("https://")&&(d.url=c.baseUrl+a);0<Object.keys(b).length&&(a=d.url,b=n(b,b),b=encodeURI(b.substring(0,b.length-1).split(" ").join("+")),d.url=a+("?"+b));d.method="GET";return h(d)},m=function(a,b,d){b={success:b,error:d,headers:{}};b.headers.Authorization=c.token?c["public"]+":"+c.token:c["public"];0>a.indexOf("https://")&&(b.url=c.baseUrl+a);b.method="DELETE";return h(b)},
f=function(a,b,d,g){b={success:d,error:g,data:b,headers:{}};b.headers.Authorization=c.token?c["public"]+":"+c.token:c["public"];0>a.indexOf("https://")&&(b.url=c.baseUrl+a);b.method="POST";return h(b)},p=function(a,b,d,g){b={success:d,error:g,data:b,headers:{}};b.headers.Authorization=c.token?c["public"]+":"+c.token:c["public"];0>a.indexOf("https://")&&(b.url=c.baseUrl+a);b.method="PATCH";return h(b)},q=function(a,b,d,g){b={success:d,error:g,data:b,headers:{}};b.headers.Authorization=c.token?c["public"]+
":"+c.token:c["public"];0>a.indexOf("https://")&&(b.url=c.baseUrl+a);b.method="PUT";return h(b)},w="object"==typeof self&&self.self===self&&self||"object"==typeof global&&global.global===global&&global||this,c={"public":null,token:null,baseUrl:"https://api.marketcloud.it/v0",storage:new l,getToken:function(){c.token||(c.token=c.storage.get("marketcloud.access_token"));return c.token},setToken:function(a){if("string"!==typeof a)throw Error("Token must be string.");c.token=a;c.storage.set("marketcloud.access_token",
a)},forgetToken:function(){c.token=null;c.storage.del("marketcloud.access_token")},setPublicKey:function(a){if("string"!==typeof a)throw Error("Public key must be string.");c["public"]=a},getPublicKey:function(){return c["public"]},addresses:{},brands:{},carts:{},categories:{},currencies:{},orders:{},payments:{},products:{},shippings:{},stores:{},taxes:{},users:{}};c.brands.list=function(a,b){e("/brands",a||{},function(a){b(null,a.data)},function(a){b(a.errors[0],null)})};c.brands.getById=function(a,
b){e("/brands/"+a,{},function(a){b(null,a.data)},function(a){b(a.errors[0],null)})};c.addresses.create=function(a,b){f("/addresses/",a,function(a){b(null,a.data)},function(a){b(a.errors[0],null)})};c.addresses.update=function(a,b,d){q("/addresses/"+a,b,function(b){d(null,b.data)},function(b){d(b.errors[0],null)})};c.addresses["delete"]=function(a,b){m("/addresses/"+a,function(a){b(null,a.data)},function(a){b(a.errors[0],null)})};c.addresses.list=function(a,b){e("/addresses",a||{},function(a){b(null,
a.data)},function(a){b(a.errors[0],null)})};c.addresses.getById=function(a,b){e("/addresses/"+a,{},function(a){b(null,a.data)},function(a){b(a.errors[0],null)})};c.categories.list=function(a,b){e("/categories",a||{},function(a){b(null,a.data)},function(a){b(a.errors[0],null)})};c.categories.getById=function(a,b){e("/categories/"+a,{},function(a){b(null,a.data)},function(a){b(a.errors[0],null)})};c.currencies.list=function(a,b){e("/currencies",a||{},function(a){b(null,a.data)},function(a){b(a.errors[0],
null)})};c.currencies.getById=function(a,b){e("/currencies/"+a,{},function(a){b(null,a.data)},function(a){b(a.errors[0],null)})};c.orders.create=function(a,b){f("/orders/",a,function(a){b(null,a.data)},function(a){b(a.errors[0],null)})};c.orders.list=function(a,b){e("/orders",a||{},function(a){b(null,a.data)},function(a){b(a.errors[0],null)})};c.orders.getById=function(a,b){e("/orders/"+a,{},function(a){b(null,a.data)},function(a){b(a.errors[0],null)})};c.products.list=function(a,b){e("/products",
a||{},function(a){b(null,a.data)},function(a){b(a.errors[0],null)})};c.products.getById=function(a,b){e("/products/"+a,{},function(a){b(null,a.data)},function(a){b(a.errors[0],null)})};c.payments.create=function(a,b){if("object"!==typeof a)throw Error("First argument must be object");if(!a.hasOwnProperty("method"))throw Error("Must provide a payment method.");f("/payments",a,function(a){b(null,a.data)},function(a){b(a.errors[0],null)})};c.payments.braintree={};c.payments.braintree.createClientToken=
function(a){f("/integrations/braintree/clientToken",{},function(b){a(null,b.data)},function(b){a(b.errors[0],null)})};c.shippings.list=function(a,b){e("/shippings",a||{},function(a){b(null,a.data)},function(a){b(a.errors[0],null)})};c.shippings.getById=function(a,b){e("/shippings/"+a,{},function(a){b(null,a.data)},function(a){b(a.errors[0],null)})};c.stores.create=function(a,b){f("/stores/",a,function(a){b(null,a.data)},function(a){b(a.errors[0],null)})};c.stores.update=function(a,b,c){q("/stores/"+
a,b,function(a){c(null,a.data)},function(a){c(a.errors[0],null)})};c.stores["delete"]=function(a,b){m("/stores/"+a,function(a){b(null,a.data)},function(a){b(a.errors[0],null)})};c.stores.list=function(a,b){e("/stores",a||{},function(a){b(null,a.data)},function(a){b(a.errors[0],null)})};c.stores.getById=function(a,b){e("/stores/"+a,function(a){b(null,a.data)},function(a){b(a.errors[0],null)})};c.taxes.list=function(a,b){e("/taxes",a||{},function(a){b(null,a.data)},function(a){b(a.errors[0],null)})};
c.taxes.getById=function(a,b){e("/taxes/"+a,{},function(a){b(null,a.data)},function(a){b(a.errors[0],null)})};c.users.create=function(a,b){f("/users/",a,function(a){b(null,a.data)},function(a){b(a.errors[0],null)})};c.users.update=function(a,b,c){q("/users/"+a,b,function(a){c(null,a.data)},function(a){c(a.errors[0],null)})};c.users["delete"]=function(a,b){m("/users/"+a,function(a){b(null,a.data)},function(a){b(a.errors[0],null)})};c.users.list=function(a,b){e("/users",a||{},function(a){b(null,a.data)},
function(a){b(a.errors[0],null)})};c.users.getById=function(a,b){e("/users/"+a,{},function(a){b(null,a.data)},function(a){b(a.errors[0],null)})};c.users.isLoggedIn=function(){return c.token?!0:!1};c.users.getCurrent=function(a){if(c.token)e("/users/current",{},function(b){a(null,b.data)},function(b){a(b.errors[0],null)});else throw k("Called users.getCurrent without a token"),Error("Cannot get current user information without a user access token. Obtain a user access token first.");};c.users.authenticate=
function(a,b,d){c.token=null;c.user=null;f("/users/authenticate",{password:b,email:a},function(a){c.setToken(a.data.token);c.user=a.data.user;d(null,a.data)},function(a){d(a.errors[0],null)})};c.users.authenticateWithFacebook=function(a,b,d){f("/users/authenticate/facebook",{access_token:b,user_id:a},function(a){c.setToken(a.data.token);c.user=a.data.user;d(null,a.data)},function(a){d(a.errors[0],null)})};c.users.logout=function(a){c.token=null;c.storage.del("marketcloud.access_token");c.storage.del("marketcloud.cart_id");
a&&a()};c.carts.create=function(a,b){var c=null,c=a instanceof Array?{items:a}:a;f("/carts",c,function(a){b(null,a.data)},function(a){b(a.errors[0],null)})};c.carts.add=function(a,b,c){if(b instanceof Array)p("/carts/"+a,{op:"add",items:b},function(a){c(null,a.data)},function(a){c(a.errors[0],null)});else throw Error("addToCart(cart_id,data,callback) data must be an array [{product_id :1,quantity : 7}]");};c.carts.remove=function(a,b,c){if(b instanceof Array)p("/carts/"+a,[{op:"remove",items:b}],
function(a){c(null,a.data)},function(a){c(a.errors[0],null)});else throw Error("removeFromCart(cart_id,data,callback) data must be an array [{product_id :1,product_id : 7}]");};c.carts.update=function(a,b,c){if(b instanceof Array)p("/carts/"+a,[{op:"update",items:b}],function(a){c(null,a.data)},function(a){c(a.errors[0],null)});else throw Error("removeFromCart(cart_id,data,callback) data must be an array [{product_id :1,product_id : 7}]");};c.carts.getCurrent=function(a){var b=c.storage.get("marketcloud.cart_id");
if(b)e("/carts/"+b,{},function(b){a(null,b.data)},function(b){a(b.errors[0],null)});else return null};c.carts.getById=function(a,b){e("/carts/"+a,{},function(a){b(null,a.data)},function(a){b(a.errors[0],null)})};c.carts.getByUser=function(a){if(null===c.user)throw Error("Cannot get current user's cart without a user access token. You need to authenticate the user first.");e("/carts",{},function(b){a(null,b.data)},function(b){a(b.errors[0],null)})};c.carts["delete"]=function(a,b){m("/carts/"+a,function(a){b(null,
a.data)},function(a){b(a.errors[0],null)})};c.carts.checkout=function(a,b){if(!a.hasOwnProperty("cart_id")&&!a.hasOwnProperty("items")&&!c.storage.get("marketcloud.cart_id"))throw Error("marketcloud.carts.checkout(data,callback) missing cart data, provide cart_id or items array.");return c.orders.create(a,b)};c.token=c.getToken();w.marketcloud=c})();